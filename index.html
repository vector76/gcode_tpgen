<html>
<head>
<title>G-Code Test Pattern Generator</title>
<style>
.output {
  font-family: monospace;
  font-size: 8pt;
}
</style>
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
</head>
<body>
<table>
<tr><td>;Start with G92 X0 Y0 Z0:</td><td><input type="checkbox" name="zero" checked></td></tr>
<tr><td>;Z level for pen-down:</td><td><input type="text" name="pen_d" value="-0.5"></td></tr>
<tr><td>;Z level for pen-up:</td><td><input type="text" name="pen_u" value="0.5"></td></tr>
<tr><td>;Rapid Feedrate (mm/min):</td><td><input type="text" name="rapid" value="2000"></td></tr>
<tr><td>;Raise/lower Feedrate:</td><td><input type="text" name="vertical" value="800"></td></tr>
<tr><td>;Draw Feedrate:</td><td><input type="text" name="drawspeed" value="1000"></td></tr>
<tr><td>;Mode:</td><td>
<input type="radio" name="mode" id="mode_x" checked> ;X ruler<br>
<input type="radio" name="mode" id="mode_y"> ;Y ruler<br>
<input type="radio" name="mode" id="mode_xy"> ;X and Y ruler<br>
<input type="radio" name="mode" id="mode_perim"> ;Perimeter ruler<br>
<input type="radio" name="mode" id="mode_ztest_corners"> ;Z test four corners<br>
<input type="radio" name="mode" id="mode_ztest_grid"> ;Z test grid</td></tr>
<tr><td>;X Extent (mm):</td><td><input type="text" name="xsize" value="100"></td></tr>
<tr><td>;Y Extent (mm):</td><td><input type="text" name="ysize" value="100"></td></tr>
<tr><td>;Z Test Cross Size (mm):</td><td><input type="text" name="zxsize" value="14"></td></tr>
<tr><td></td><td><input type="button" value="Generate" onclick="generate()"></td></tr>
</table>
;Github repository here: <a href="https://github.com/vector76/gcode_tpgen">https://github.com/vector76/gcode_tpgen</a><br>
<pre id="output" class="output">
</pre>

<script>
  function output_append(x) {
    var output = document.getElementById('output');
    var newcontent = document.createElement('div');
    newcontent.innerHTML = x + "\n";

    while (newcontent.firstChild) {
        output.appendChild(newcontent.firstChild);
    }
  }

  function x_zig(xstart, xend, ymid, zup, zdn, rapid, vertical, drawspeed) {
    for (var x=xstart; x <= xend; x++) {
      var yend = ymid-0.5;
      var ystart = yend-5.5;  // most draw from ymid-5.5 to ymid-0.5
      if (x % 5 == 0) {
        ystart = ystart - 2;
      }
      if (x % 10 == 0) {
        ystart = ystart - 2;
      }
      output_append("G1 X" + x + " Y" + ystart + zup + " F" + rapid);
      output_append("G1 X" + x + " Y" + ystart + zdn + " F" + vertical);
      output_append("G1 X" + x + " Y" + yend + zdn + " F" + drawspeed);
      output_append("G1 X" + x + " Y" + yend + zup + " F" + vertical);
    }
  }
  
  function x_zag(xstart, xend, ymid, zup, zdn, rapid, vertical, drawspeed) {
    for (var x=xend; x >= xstart; x--) {
      var ystart = ymid + 0.5;
      var yend = ystart + 5.5; // most go from ymid+0.5 to ymid+6
      if (x % 5 == 0) {
        yend = yend + 2;   // 5 and 10 mm go from ymid+0.5 to ymid+8
      }
      if (x % 10 == 0) {
        yend = yend + 2;   // 10 mm goes from ymid+0.5 to ymid+10
      }
      output_append("G1 X" + x + " Y" + ystart + zup + " F" + rapid);
      output_append("G1 X" + x + " Y" + ystart + zdn + " F" + vertical);
      output_append("G1 X" + x + " Y" + yend + zdn + " F" + drawspeed);
      output_append("G1 X" + x + " Y" + yend + zup + " F" + vertical);
    }
  }
  
  function y_zig(xmid, ystart, yend, zup, zdn, rapid, vertical, drawspeed) {
    for (var y=ystart; y <= yend; y++) {
      var xend = xmid-0.5;
      var xstart = xend-5.5;
      if (y % 5 == 0) {
        xstart = xstart - 2;
      }
      if (y % 10 == 0) {
        xstart = xstart - 2;
      }
      output_append("G1 X" + xstart + " Y" + y + zup + " F" + rapid);
      output_append("G1 X" + xstart + " Y" + y + zdn + " F" + vertical);
      output_append("G1 X" + xend + " Y" + y + zdn + " F" + drawspeed);
      output_append("G1 X" + xend + " Y" + y + zup + " F" + vertical);
    }
  }
  
  function y_zag(xmid, ystart, yend, zup, zdn, rapid, vertical, drawspeed) {
    for (var y=yend; y >= ystart; y--) {
      var xstart = xmid + 0.5;
      var xend = xstart + 5.5;
      if (y % 5 == 0) {
        xend = xend + 2;
      }
      if (y % 10 == 0) {
        xend = xend + 2;
      }
      output_append("G1 X" + xstart + " Y" + y + zup + " F" + rapid);
      output_append("G1 X" + xstart + " Y" + y + zdn + " F" + vertical);
      output_append("G1 X" + xend + " Y" + y + zdn + " F" + drawspeed);
      output_append("G1 X" + xend + " Y" + y + zup + " F" + vertical);
    }
  }
  
  function z_test(x, y, size, zup, zdn, rapid, drawspeed) {
    var x0 = x - size/2;
    var x1 = x + size/2;
    var y0 = y - size/2;
    var y1 = y + size/2;
    // convert to strings, keeping three decimals
    x0 = x0.toFixed(3);
    x1 = x1.toFixed(3);
    y0 = y0.toFixed(3);
    y1 = y1.toFixed(3);
    x = x.toFixed(3);
    y = y.toFixed(3);
    output_append("G1 X" + x0 + " Y" + y0 + zup + " F" + rapid);
    output_append("G1 X" + x + " Y" + y + zdn + " F" + drawspeed);
    output_append("G1 X" + x1 + " Y" + y1 + zup + " F" + drawspeed);
    output_append("G1 X" + x0 + " Y" + y1 + zup + " F" + rapid);
    output_append("G1 X" + x + " Y" + y + zdn + " F" + drawspeed);
    output_append("G1 X" + x1 + " Y" + y0 + zup + " F" + drawspeed);
  }
  
  function generate() {
    // clear output in case it's been run already:
    document.getElementById('output').innerHTML = "";
    
    var zero = document.getElementsByName("zero")[0].checked;
    var pen_d = document.getElementsByName("pen_d")[0].value;
    var pen_u = document.getElementsByName("pen_u")[0].value;
    var rapid = document.getElementsByName("rapid")[0].value;
    var vertical = document.getElementsByName("vertical")[0].value;
    var drawspeed = document.getElementsByName("drawspeed")[0].value;
    var ysize = document.getElementsByName("ysize")[0].value;
    var xsize = document.getElementsByName("xsize")[0].value;
    var zxsize = document.getElementsByName("zxsize")[0].value;
    var mode = "";
    if (document.getElementById("mode_x").checked) {
      mode = "x";
    }
    if (document.getElementById("mode_y").checked) {
      mode = "y";
    }
    if (document.getElementById("mode_xy").checked) {
      mode = "xy";
    }
    if (document.getElementById("mode_perim").checked) {
      mode = "perim";
    }
    if (document.getElementById("mode_ztest_corners").checked) {
      mode = "ztest_corners";
    }
    if (document.getElementById("mode_ztest_grid").checked) {
      mode = "ztest_grid";
    }
    
    output_append("; pen down z level: " + pen_d);
    output_append("; pen up z level: " + pen_u);
    output_append("; rapid feedrate: " + rapid);
    output_append("; raise/lower feedrate: " + vertical);
    output_append("; drawing feedrate: " + drawspeed);
    output_append("; x extent: " + xsize);
    output_append("; y extent: " + ysize);
    output_append("; mode: " + mode);
    
    var zup = " Z" + pen_u;
    var zdn = " Z" + pen_d;
    
    if (zero) {
      output_append("G92 X0 Y0 Z0");
    }
    
    if (mode == "x" || mode == "xy" || mode == "perim") {
      x_zig(0, xsize, 10, zup, zdn, rapid, vertical, drawspeed);
      x_zag(0, xsize, 10, zup, zdn, rapid, vertical, drawspeed);
    }
    
    if (mode == "y" || mode == "xy" || mode == "perim") {
      y_zig(10, 0, ysize, zup, zdn, rapid, vertical, drawspeed);
      y_zag(10, 0, ysize, zup, zdn, rapid, vertical, drawspeed);
    }
    
    if (mode == "perim") {
      x_zig(0, xsize, ysize-10, zup, zdn, rapid, vertical, drawspeed);
      x_zag(0, xsize, ysize-10, zup, zdn, rapid, vertical, drawspeed);
      y_zig(xsize-10, 0, ysize, zup, zdn, rapid, vertical, drawspeed);
      y_zag(xsize-10, 0, ysize, zup, zdn, rapid, vertical, drawspeed);
    }
    
    if (mode == "ztest_corners") {
      output_append("G1" + zup + " F" + vertical);
      z_test(zxsize/2, zxsize/2, zxsize, zup, zdn, rapid, drawspeed);
      z_test(xsize-zxsize/2, zxsize/2, zxsize, zup, zdn, rapid, drawspeed);
      z_test(xsize-zxsize/2, ysize-zxsize/2, zxsize, zup, zdn, rapid, drawspeed);
      z_test(zxsize/2, ysize-zxsize/2, zxsize, zup, zdn, rapid, drawspeed);
    }

    if (mode == "ztest_grid") {
      output_append("G1" + zup + " F" + vertical);
      // minimum 1 mm space between X marks: N*zxsize+(N-1)*space <= xsize (or ysize)
      var space = 1;
      var num_x = Math.floor((xsize+space)/(zxsize+space));
      var num_y = Math.floor((ysize+space)/(zxsize+space));
      if (num_x < 2 || num_y < 2) {
        output_append("; not enough room for grid");
      }
      else {
        var step_x = (xsize-zxsize)/(num_x-1);
        var step_y = (ysize-zxsize)/(num_y-1);
        for (var iy=0; iy < num_y; iy++) {
          if (iy % 2 == 0) {
            for (var ix=0; ix < num_x; ix++) {
              z_test(zxsize/2+ix*step_x, zxsize/2+iy*step_y, zxsize, zup, zdn, rapid, drawspeed);
            }
          }
          else {
            for (var ix=num_x-1; ix >= 0; ix--) {
              z_test(zxsize/2+ix*step_x, zxsize/2+iy*step_y, zxsize, zup, zdn, rapid, drawspeed);
            }
          }
        }
      }
    }

    download('testpattern.gcode', document.getElementById('output').innerHTML);
  }
  
  
  function download(filename, text) {
    var pom = document.createElement('a');
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    pom.setAttribute('download', filename);

    if (document.createEvent) {
      var event = document.createEvent('MouseEvents');
      event.initEvent('click', true, true);
      pom.dispatchEvent(event);
    }
    else {
      pom.click();
    }
  }
</script>
</body>
</html>